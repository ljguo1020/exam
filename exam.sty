\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{exam}[2021/12/13 v0.1 test]

\newif\ifprint
\printfalse

\DeclareOption{print}{%
  \printtrue
}

\ProcessOptions

\IfFontExistsTF{Source Han Serif SC}{
    \setCJKmainfont{Source Han Serif SC}
}{}

% \RequirePackage{showframe}

% \ctexset{
%     section/format  =   {\normalsize\raggedright\bfseries}
% }

\xeCJKsetup{CheckSingle=true}
\RequirePackage{tcolorbox}
\tcbuselibrary{breakable}
\tcbuselibrary{skins}
\tcbset{
    width   =   \linewidth,
    fonttitle=  \bfseries,
    breakable,
    enhanced jigsaw
    % lines before break=0
}
\RequirePackage{mathtools}
\RequirePackage{unicode-math}
\RequirePackage[mono=false]{libertinus-otf}
% \setmainfont{TeX Gyre Pagella}
% \setmathfont{TeX Gyre Pagella Math}
% \setmathfont{NewCMMath-Book.otf}
\setmathfont{latinmodern-math.otf}[range={\lbrace, \rbrace}]
% \setmathfont{TeX Gyre Pagella Math}[range=bb]


\RequirePackage[margin=1.5cm]{geometry}

\RequirePackage[notrig]{physics}
\RequirePackage{nicematrix}
\RequirePackage[colorlinks=true, linkcolor=blue]{hyperref}

% https://tex.stackexchange.com/questions/307412/redefine-pi-to-pi-with-unicode-math
\AtBeginDocument{%
  \let\umathpi\pi
  \renewcommand\pi{\symup\umathpi}%
}

\let\set\qty
\let\emph\textbf
\AtBeginDocument{
    \let\ge\geqslant
    \let\le\leqslant
    \let\hom\symscr
}

\def\grad{\symbf{\nabla}}
\let\boldsymbol\symbfit

\newcommand{\limit}[2]{\lim_{#1 \to #2}}
\newcommand{\me}{\symrm{e}}
\newcommand{\mi}{\symrm{i}}
\newcommand{\R}{\ensuremath{\symbb{R}}}
\newcommand{\K}{\ensuremath{\symbb{K}}}
\newcommand{\N}{\ensuremath{\symbb{N}}}
\newcommand{\C}{\ensuremath{\symbb{C}}}
\newcommand{\Q}{\ensuremath{\symbb{Q}}}
% 可以用 D(){} 来做定界符
\NewDocumentCommand{\MM}{ O{\R} O{n} }{ \ensuremath{\symup{M}_{#2}(#1)} }
\DeclareMathOperator{\diag}{diag} 
% \DeclareMathOperator{\deg}{deg} 
\DeclareMathOperator{\Image}{Im}
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\sgn}{sgn}

\renewcommand{\thempfootnote}{\arabic{mpfootnote}}

% 打印提示和答案列表, 并创建超链接

\def\hitem{%
  \letcs{\originallabel}{labeloriexercise\romannumeral\enit@depth}%
  % the same as \@namedef
  \csedef{labeloriexercise\romannumeral\enit@depth\expandafter}%
    {\noexpand\textbf{*\expandonce\originallabel}}%
  \item
  \cslet{labeloriexercise\romannumeral\enit@depth}\originallabel
}

\def\sitem{%
  \letcs{\originallabel}{labeloriexercise\romannumeral\enit@depth}%
  % the same as \@namedef
  \csedef{labeloriexercise\romannumeral\enit@depth\expandafter}%
    {\noexpand\bfseries\noexpand\color{red}{*\expandonce\originallabel}}%
  \item
  \cslet{labeloriexercise\romannumeral\enit@depth}\originallabel
}


% \newcommand{\uselistlabel}[2]{%
%   \stepcounter{oriexercisei}%
%   \llap{#1}%
%   % see https://github.com/jbezos/enumitem/blob/1bdcad0987823b3716c86b126b3863f895ea9c4a/enumitem.sty#L1371
%   #2{\@nameuse{labeloriexercisei}}%
% }

\RequirePackage{verbatim}

\newwrite\ltxex@ansfile
\newwrite\ltxex@hintfile

\def\ltxex@ansfilename{\jobname.ans}
\def\ltxex@hintfilename{\jobname.hint}

\newcommand\startexercise{%
  \immediate\openout\ltxex@ansfile=\ltxex@ansfilename
  \immediate\write\ltxex@ansfile{\noexpand\begin{answersheet}}
  \immediate\openout\ltxex@hintfile=\ltxex@hintfilename
  \immediate\write\ltxex@hintfile{\noexpand\begin{hintsheet}}}

\newcommand\stopexercise{%
  \immediate\write\ltxex@ansfile{\noexpand\end{answersheet}}%
  \immediate\closeout\ltxex@ansfile
  \immediate\write\ltxex@hintfile{\noexpand\end{hintsheet}}%
  \immediate\closeout\ltxex@hintfile}

\newcommand\printanswer{%
  \InputIfFileExists{\ltxex@ansfilename}%
    {\PackageInfo{latexexercise}{answer file `\ltxex@ansfilename' inputed.}}%
    {\PackageWarning{latexexercise}%
      {answer file `\ltxex@ansfilename' does not exsist.}}}

\newcommand\printhint{%
  \InputIfFileExists{\ltxex@hintfilename}%
  {\PackageInfo{latexexercise}{hint file `\ltxex@hintfilename' inputed.}}%
  {\PackageWarning{latexexercise}%
    {hint file `\ltxex@hintfilename' does not exsist.}}}

\newenvironment{answer}%
{ 
  \immediate\write\ltxex@ansfile{\noexpand\item[\noexpand\ref{\number\csname c@oriexercisei\endcsname:exer}.] \noexpand\GetRef{\number\csname c@oriexercisei\endcsname:answ}\noexpand\label{\number\csname c@oriexercisei\endcsname:answ}}%
  \ltxex@startwriteans%
}%
{\ltxex@endwrite}

\newenvironment{hint}%
{ 
  \immediate\write\ltxex@hintfile{\noexpand\item[\noexpand\ref{\number\csname c@oriexercisei\endcsname:exer}.] \noexpand\GetRef{\number\csname c@oriexercisei\endcsname:hint}\noexpand\label{\number\csname c@oriexercisei\endcsname:hint}}%
  \ltxex@startwritehint%
}%
{\ltxex@endwrite}

% \RequirePackage{letltxmacro}
% \let\vb\symbfit
\RequirePackage[shortlabels, inline]{enumitem} % 继承并扩展了enumerate宏包的功能
\setlist[enumerate, 1]{leftmargin=*, label=\arabic*., widest=000, ref=\arabic*}
\setlist[enumerate, 2]{leftmargin=*, label=(\arabic*)}
\newlist{oriexercise}{enumerate}{2}
\setlist[oriexercise, 1]{leftmargin=*, label=\arabic*., widest=000, ref=\arabic*}
\setlist[oriexercise, 2]{leftmargin=*, label=(\arabic*)}
\newlist{answersheet}{enumerate}{2}
\setlist[answersheet, 1]{leftmargin=*, label=\arabic*., widest=000, ref=\arabic*}
\setlist[answersheet, 2]{leftmargin=*, label=(\arabic*)}
\newlist{hintsheet}{enumerate}{2}
\setlist[hintsheet, 1]{leftmargin=*, label=\arabic*., widest=000, ref=\arabic*}
\setlist[hintsheet, 2]{leftmargin=*, widest={方法一}, label=(\textbf{方法\chinese*})}

\RequirePackage{letltxmacro}
\LetLtxMacro{\it@m}{\item}

\NewDocumentCommand{\GetRef}{ m }{\protected@edef\@currentlabel{\getrefnumber{#1}}}%

  \def\asteriskitem{*}
% https://tex.stackexchange.com/a/328393/180617
\NewDocumentCommand{\new@item}{ o }{
    \IfNoValueTF{#1}{\it@m}{\it@m[#1]\phantomsection\protected@edef\@currentlabel{#1}}}

\let\item\new@item

\NewDocumentEnvironment{exercise}{ o }{
  \RenewDocumentCommand{\item}{ s s o }{
    \IfNoValueTF{##3}{\it@m}{\it@m[##3]}%
    \ifnum\enit@depth=\@ne
      \expandafter\label\expandafter{\number\csname c@oriexercisei\endcsname:exer} 
      \ifprint \else
      \@ifundefined{r@\number\csname c@oriexercisei\endcsname:exer}{[提示]}{
      \hyperref[\number\csname c@oriexercisei\endcsname:hint]{[提示]}}%        
      \@ifundefined{r@\number\csname c@oriexercisei\endcsname:exer}{[答案]}{
      \hyperref[\number\csname c@oriexercisei\endcsname:answ]{[答案]}}
      \fi
    \fi
  }
  % \let\hitem\item
  % \let\sitem\item
  \IfValueTF{#1}{%
    \begin{oriexercise}[#1]
  }{
    \begin{oriexercise}
  }
}{\end{oriexercise}}

\def\ltxex@startwriteans{%
  \begingroup
  \@bsphack
  \let\do\@makeother \dospecials
  \catcode`\^^M\active
  \def\verbatim@processline{%
    \immediate\write\ltxex@ansfile{\the\verbatim@line}}%
  \verbatim@start}

  \def\ltxex@startwritehint{%
  \begingroup
  \@bsphack
  \let\do\@makeother \dospecials
  \catcode`\^^M\active
  \def\verbatim@processline{%
    \immediate\write\ltxex@hintfile{\the\verbatim@line}}%
  \verbatim@start}

\def\ltxex@endwrite{\@esphack\endgroup}
